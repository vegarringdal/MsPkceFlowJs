var k=Object.defineProperty;var S=r=>{throw TypeError(r)};var v=(r,e,o)=>e in r?k(r,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[e]=o;var i=(r,e,o)=>v(r,typeof e!="symbol"?e+"":e,o),K=(r,e,o)=>e.has(r)||S("Cannot "+o);var m=(r,e,o)=>e.has(r)?S("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,o);var c=(r,e,o)=>(K(r,e,"access private method"),o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function o(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(t){if(t.ep)return;t.ep=!0;const s=o(t);fetch(t.href,s)}})();var n,p,y,_,w,L;class b{constructor(e,o){m(this,n);i(this,"authConfig");i(this,"stateLocalStorageKey","__key");i(this,"verifierLocalStorageKey","__verifier");i(this,"codeLocalStorageKey","__code");i(this,"lasturlLocalStorageKey","__lastUrl");i(this,"useOldStateLocalStorageKey","__useOldState");i(this,"accountLocalStorageKey","__account");i(this,"currentAccount",null);i(this,"useLog",!1);i(this,"callback");this.authConfig=e,this.currentAccount=null,this.callback=o||function(){}}getAccessToken(){var e;return(e=this.currentAccount)==null?void 0:e.access_token}async updateToken(){var o;const e=(o=this.currentAccount)==null?void 0:o.refresh_token;if(e){const[a,t]=c(this,n,w).call(this,e),s=await fetch(a,{body:t,method:"POST"});if(s.ok){const l=await s.json();return this.saveToken(l),this.currentAccount}}else throw"no refresh token available"}async activate(){const e=location.hash.replace("#","");let o=new URLSearchParams(e).get("code"),a=new URLSearchParams(e).get("state");const t=sessionStorage.getItem(this.stateLocalStorageKey),s=sessionStorage.getItem(this.verifierLocalStorageKey);if(sessionStorage.getItem(this.useOldStateLocalStorageKey)&&(a=t,o=sessionStorage.getItem(this.codeLocalStorageKey)),o&&t&&s&&t===a){const u=sessionStorage.getItem(this.lasturlLocalStorageKey);if(u){sessionStorage.removeItem(this.lasturlLocalStorageKey),sessionStorage.setItem(this.useOldStateLocalStorageKey,"TRUE"),sessionStorage.setItem(this.codeLocalStorageKey,o);const d=JSON.parse(u);location.href=`${location.origin}${d.pathname}${d.search}${d.hash}`;return}sessionStorage.removeItem(this.useOldStateLocalStorageKey);const h=`https://login.microsoftonline.com/${this.authConfig.tenant_id}/oauth2/v2.0/token`,g=new FormData;g.append("scope",this.authConfig.scope),g.append("code",o),g.append("client_id",this.authConfig.client_id),g.append("redirect_uri",this.authConfig.redirect_uri),g.append("grant_type","authorization_code"),g.append("code_verifier",s);const f=await fetch(h,{body:g,method:"POST"});if(sessionStorage.removeItem(this.verifierLocalStorageKey),sessionStorage.removeItem(this.stateLocalStorageKey),f.ok){const d=await f.json();return this.saveToken(d),await this.reSheduleRefresh(),d}else return console.error(f.status,f.statusText),null}else{if(s&&t)throw sessionStorage.removeItem(this.verifierLocalStorageKey),sessionStorage.removeItem(this.stateLocalStorageKey),sessionStorage.removeItem(this.useOldStateLocalStorageKey),"auth failed";{sessionStorage.setItem(this.lasturlLocalStorageKey,JSON.stringify({pathname:location.pathname,search:location.search,hash:location.hash}));const u=sessionStorage.getItem(this.accountLocalStorageKey);if(u)return this.currentAccount=JSON.parse(u),await this.reSheduleRefresh(),this.currentAccount;await c(this,n,p).call(this)}}}log(e){this.useLog&&console.log(e)}async reSheduleRefresh(){if(!this.currentAccount){await c(this,n,p).call(this);return}const e=new Date(this.currentAccount.expire_isoString).getTime(),o=new Date().getTime(),a=e-o,t=1e3*60*5,s=a-t;if(a<0){await c(this,n,p).call(this);return}s<0&&await this.updateToken().catch(async()=>{await c(this,n,p).call(this)}),this.callback(this.currentAccount),this.log(`scheduled refresh in ${s/1e3/60}`),setTimeout(async()=>{await this.updateToken().catch(async()=>{sessionStorage.setItem(this.lasturlLocalStorageKey,JSON.stringify({pathname:location.pathname,search:location.search,hash:location.hash})),await c(this,n,p).call(this)}),this.currentAccount&&this.callback(this.currentAccount)},s)}saveToken(e){var o;e.access_token&&(e.access_token_tokenDecoded=c(this,n,y).call(this,e.access_token)),e.expire_isoString=new Date(((o=e.access_token_tokenDecoded)==null?void 0:o.exp)*1e3).toISOString(),e.expire_localString=new Date(e.expire_isoString),this.currentAccount=e,sessionStorage.setItem(this.accountLocalStorageKey,JSON.stringify(e))}}n=new WeakSet,p=async function(){const e=await c(this,n,L).call(this);window.open(e,"_self")},y=function(e){if(!e)return{};const o=e.split(".")[1];if(!o)return{};const a=o.replace(/-/g,"+").replace(/_/g,"/"),t=decodeURIComponent(window.atob(a).split("").map(function(s){return"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(t)},_=async function(e=96){const o=await crypto.getRandomValues(new Uint8Array(e));let a="";o.forEach(h=>{a+=String.fromCharCode(h)});const t=window.btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),s=new Uint8Array(t.length);for(let h=0;h<t.length;h++)s[h]=t.charCodeAt(h);const l=await crypto.subtle.digest("SHA-256",s),u=String.fromCharCode.apply(null,new Uint8Array(l));return{verifier:t,challenge:window.btoa(u).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}},w=function(e){const o=`https://login.microsoftonline.com/${this.authConfig.tenant_id}/oauth2/v2.0/token`,a=new FormData;return a.append("client_id",this.authConfig.client_id),a.append("refresh_token",e),a.append("scope",this.authConfig.scope),a.append("grant_type","refresh_token"),[o,a]},L=async function(){const e=await c(this,n,_).call(this),o=crypto.randomUUID();sessionStorage.setItem(this.verifierLocalStorageKey,e.verifier),sessionStorage.setItem(this.stateLocalStorageKey,o);const a=`https://login.microsoftonline.com/${this.authConfig.tenant_id}/oauth2/v2.0/authorize`,t=new URLSearchParams;return t.append("client_id",this.authConfig.client_id),t.append("response_type","code"),t.append("response_mode","fragment"),t.append("scope",this.authConfig.scope),t.append("state",o),t.append("code_challenge",e.challenge),t.append("redirect_uri",this.authConfig.redirect_uri),t.append("code_challenge_method","S256"),a+"?"+t.toString()};async function I(){let r="http://localhost:8080";location.host==="vegarringdal.github.io"&&(r="https://vegarringdal.github.io/MsPkceFlowJs/");const e=new b({client_id:"2bca3844-d481-4fd0-a2fe-53a237ec28ec",tenant_id:"0bfdc7b6-077d-4379-9617-c56c6453235b",scope:"api://2bca3844-d481-4fd0-a2fe-53a237ec28ec/api",redirect_uri:r},t=>{console.log(t)});e.useLog=!0;const o=await e.activate().catch(t=>{console.error(t)}),a=document.getElementById("app");if(!o&&a){a.textContent="something wrong, see console";return}if(o){const t=e.getAccessToken(),s=await e.updateToken();console.log("tokenResult:",o),console.log("accessTokenString:",t),console.log("newToken:",s),a&&(a.textContent=o.access_token_tokenDecoded.name||"who are you?")}}I();

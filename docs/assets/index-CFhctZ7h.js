var L=s=>{throw TypeError(s)};var P=(s,e,t)=>e.has(s)||L("Cannot "+t);var n=(s,e,t)=>(P(s,e,"read from private field"),t?t.call(s):e.get(s)),u=(s,e,t)=>e.has(s)?L("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),v=(s,e,t,o)=>(P(s,e,"write to private field"),o?o.call(s,t):e.set(s,t),t),S=(s,e,t)=>(P(s,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&o(h)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();var c,_,y,I,b,w,O,p,U,l,R,T,A,C,K;class J{constructor(e){u(this,l);u(this,c);u(this,_,"__key");u(this,y,"__verifier");u(this,I,"__code");u(this,b,"__lastUrl");u(this,w,"__useOldState");u(this,O,"__account");u(this,p,null);u(this,U,!1);v(this,c,e),v(this,p,null)}getAccessToken(){var e,t;return n(this,U)?(e=n(this,p))!=null&&e.access_token?k((t=n(this,p))==null?void 0:t.access_token):i("Missing access token",null):i("You need to call init before using any other functions",null)}async updateToken(){var t;const e=(t=n(this,p))==null?void 0:t.refresh_token;if(!e)return i("no refresh token available",null);try{const[o,r]=S(this,l,C).call(this,e),a=await fetch(o,{body:r,method:"POST"});if(a.ok){const h=await a.json();return S(this,l,R).call(this,h)}return i("error during update of token",a)}catch(o){return i("error during update of token",o)}}async loginRedirect(){const e=await S(this,l,K).call(this);return e.state==="error"?e:(window.open(e.data,"_self"),i("redirecting, please wait",null))}async init(){const e=location.hash.replace("#","");let t=new URLSearchParams(e).get("code"),o=new URLSearchParams(e).get("state");const r=sessionStorage.getItem(n(this,_)),a=sessionStorage.getItem(n(this,y));if(sessionStorage.getItem(n(this,w))&&(o=r,t=sessionStorage.getItem(n(this,I))),t&&r&&a&&r===o){const f=sessionStorage.getItem(n(this,b));if(f){sessionStorage.removeItem(n(this,b)),sessionStorage.setItem(n(this,w),"TRUE"),sessionStorage.setItem(n(this,I),t);const d=JSON.parse(f);return location.href=`${location.origin}${d.pathname}${d.search}${d.hash}`,i("Still logging in, redirect started",null)}sessionStorage.removeItem(n(this,w));const g=`https://login.microsoftonline.com/${n(this,c).tenant_id}/oauth2/v2.0/token`,m=new FormData;m.append("scope",n(this,c).scope),m.append("code",t),m.append("client_id",n(this,c).client_id),m.append("redirect_uri",n(this,c).redirect_uri),m.append("grant_type","authorization_code"),m.append("code_verifier",a);try{const d=await fetch(g,{body:m,method:"POST"});if(sessionStorage.removeItem(n(this,y)),sessionStorage.removeItem(n(this,_)),d.ok){const E=await d.json();return S(this,l,R).call(this,E)}else return console.error(d.status,d.statusText),i("Error during code verifying, response not OK",d)}catch(d){return i("Error during code verifying, fetch error",d)}}else{if(a&&r)return sessionStorage.removeItem(n(this,y)),sessionStorage.removeItem(n(this,_)),sessionStorage.removeItem(n(this,w)),i("auth failed",null);{sessionStorage.setItem(n(this,b),JSON.stringify({pathname:location.pathname,search:location.search,hash:location.hash}));const f=sessionStorage.getItem(n(this,O));return f?(v(this,p,JSON.parse(f)),k(n(this,p))):this.loginRedirect()}}}}c=new WeakMap,_=new WeakMap,y=new WeakMap,I=new WeakMap,b=new WeakMap,w=new WeakMap,O=new WeakMap,p=new WeakMap,U=new WeakMap,l=new WeakSet,R=function(e){var t;if(e.access_token){const o=S(this,l,T).call(this,e.access_token);if(o.state==="error")return o;e.access_token_tokenDecoded=o.data}try{return e.expire_isoString=new Date(((t=e.access_token_tokenDecoded)==null?void 0:t.exp)*1e3).toISOString(),e.expire_localString=new Date(e.expire_isoString),v(this,p,e),sessionStorage.setItem(n(this,O),JSON.stringify(e)),k(e)}catch(o){return i("Unable to save token",o)}},T=function(e){if(!e)return i("Missing token",null);try{const t=e.split(".")[1];if(!t)return i("Missing base64Url",null);const o=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(window.atob(o).split("").map(function(h){return"%"+("00"+h.charCodeAt(0).toString(16)).slice(-2)}).join("")),a=JSON.parse(r);return k(a)}catch(t){return i("Unable to parse token",t)}},A=async function(e=96){try{const t=await crypto.getRandomValues(new Uint8Array(e));let o="";t.forEach(g=>{o+=String.fromCharCode(g)});const r=window.btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),a=new Uint8Array(r.length);for(let g=0;g<r.length;g++)a[g]=r.charCodeAt(g);const h=await crypto.subtle.digest("SHA-256",a),f=String.fromCharCode.apply(null,new Uint8Array(h));return k({verifier:r,challenge:window.btoa(f).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")})}catch(t){return i("Error while generating PKCE",t)}},C=function(e){const t=`https://login.microsoftonline.com/${n(this,c).tenant_id}/oauth2/v2.0/token`,o=new FormData;return o.append("client_id",n(this,c).client_id),o.append("refresh_token",e),o.append("scope",n(this,c).scope),o.append("grant_type","refresh_token"),[t,o]},K=async function(){const e=await S(this,l,A).call(this);if(e.state==="error")return e;const t=crypto.randomUUID();sessionStorage.setItem(n(this,y),e.data.verifier),sessionStorage.setItem(n(this,_),t);const o=`https://login.microsoftonline.com/${n(this,c).tenant_id}/oauth2/v2.0/authorize`,r=new URLSearchParams;return r.append("client_id",n(this,c).client_id),r.append("response_type","code"),r.append("response_mode","fragment"),r.append("scope",n(this,c).scope),r.append("state",t),r.append("code_challenge",e.data.challenge),r.append("redirect_uri",n(this,c).redirect_uri),r.append("code_challenge_method","S256"),k(o+"?"+r.toString())};function k(s){return{state:"success",data:s}}function i(s,e){return{state:"error",error:{msg:s,err:e}}}async function N(){debugger;let s="http://localhost:8080";location.host==="vegarringdal.github.io"&&(s="https://vegarringdal.github.io/MsPkceFlowJs/");const e=new J({client_id:"2bca3844-d481-4fd0-a2fe-53a237ec28ec",tenant_id:"0bfdc7b6-077d-4379-9617-c56c6453235b",scope:"api://2bca3844-d481-4fd0-a2fe-53a237ec28ec/api",redirect_uri:s}),t=document.getElementById("app");if(!t){console.error("Unable to find app element");return}const o=await e.init();if(o.state==="error"){t.textContent=o.error.msg;return}const r=e.getAccessToken(),a=await e.updateToken();console.log("tokenResult:",o),console.log("accessTokenString:",r),console.log("newToken:",a),t.textContent=(o.data.access_token_tokenDecoded.name||"?? ")+", see console for more data"}N();
